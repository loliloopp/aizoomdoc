# ğŸ—ï¸ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«

## ĞĞ±Ñ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¬ (GUI)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚                                           â”‚
â”‚  - ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ                                             â”‚
â”‚  - ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ¾Ğ²                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                         â”‚
         â”‚                                         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CORE APPLICATION LOGIC   â”‚    â”‚   NEW CLOUD LAYER       â”‚
    â”‚                           â”‚    â”‚                         â”‚
    â”‚  - search_engine.py       â”‚    â”‚  - supabase_client.py   â”‚
    â”‚  - image_processor.py     â”‚    â”‚  - s3_storage.py        â”‚
    â”‚  - llm_client.py          â”‚    â”‚  - config.py (upd)      â”‚
    â”‚  - models.py              â”‚    â”‚  - manage_db.py         â”‚
    â”‚                           â”‚    â”‚                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
             â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                        â”‚                     â”‚
             â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
             â”‚                   â”‚ Supabase  â”‚      â”‚  S3 Cloud   â”‚
             â”‚                   â”‚PostgreSQL â”‚      â”‚   .ru       â”‚
             â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                        â”‚                  â”‚
             â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
             â”‚        â”‚               â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   LOCAL STORAGE      â”‚  â”‚   CLOUD DB  â”‚  â”‚  CLOUD STORAGE â”‚
    â”‚   (temp files)       â”‚  â”‚  (4 tables) â”‚  â”‚  (file chunks) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: User Query â†’ Response

```
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘   USER SENDS QUERY        â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Create Chat in DB   â”‚â—„â”€â”€â”€â”€â”€â”€â” supabase_client
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ .create_chat()
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Add User Message to  â”‚â—„â”€â”€â”€â”€â”€â”€â” supabase_client
                    â”‚    DB (role=user)    â”‚       â”‚ .add_message()
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Search Documents   â”‚
                    â”‚                      â”‚
                    â”‚  (search_engine.py)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Save Search Results  â”‚â—„â”€â”€â”€â”€â”€â”€â” supabase_client
                    â”‚ to Database          â”‚       â”‚ .add_search_result()
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Generate Viewports/Zoom Crops     â”‚
            â”‚   (image_processor.py)              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚
                    â–¼                    â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Upload Images    â”‚  â”‚ Store Image Info â”‚
          â”‚ to S3            â”‚  â”‚ in Database      â”‚
          â”‚                  â”‚  â”‚                  â”‚
          â”‚ s3_storage       â”‚  â”‚ supabase_client  â”‚
          â”‚ .upload_file()   â”‚  â”‚ .add_image_to_   â”‚
          â”‚                  â”‚  â”‚ message()        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Send to LLM with    â”‚
                    â”‚  Image Descriptions  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  LLM Processes and   â”‚
                    â”‚  Returns Response    â”‚
                    â”‚  (llm_client.py)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Add Assistant Messageâ”‚â—„â”€â”€â”€â”€â”€â”€â” supabase_client
                    â”‚ to DB (role=asst)    â”‚       â”‚ .add_message()
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Return Response to   â”‚
                    â”‚ User (with image     â”‚
                    â”‚ URLs from S3)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘   DISPLAY TO USER         â•‘
                    â•‘   (Chat with History)     â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‡Ğ°Ñ‚Ğ° Ğ² Ğ‘Ğ”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHAT ID: "550e8400-e29b-41d4-a716-446655440000"               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Title: "ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° XYZ"                                  â”‚
â”‚ Created: 2025-12-18 10:30:00                                   â”‚
â”‚ User: "user_123"                                               â”‚
â”‚ Document: "chats/.../document.pdf" (in S3)                    â”‚
â”‚                                                                 â”‚
â”‚ MESSAGES:                                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Message 1                                                 â”‚  â”‚
â”‚ â”‚ Role: user                                                â”‚  â”‚
â”‚ â”‚ Content: "ĞĞ°Ğ¹Ğ´Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ğ¸"                â”‚  â”‚
â”‚ â”‚ Created: 10:30:15                                         â”‚  â”‚
â”‚ â”‚ Images: []                                                â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Message 2                                                 â”‚  â”‚
â”‚ â”‚ Role: assistant                                           â”‚  â”‚
â”‚ â”‚ Content: "ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ğ» Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ 5..."         â”‚  â”‚
â”‚ â”‚ Created: 10:30:45                                         â”‚  â”‚
â”‚ â”‚                                                           â”‚  â”‚
â”‚ â”‚ Images:                                                   â”‚  â”‚
â”‚ â”‚  - image_id: "abc123"                                     â”‚  â”‚
â”‚ â”‚    name: "viewport_step_1.png"                            â”‚  â”‚
â”‚ â”‚    s3_path: "chats/.../images/viewport_step_1.png"      â”‚  â”‚
â”‚ â”‚    s3_url: "https://s3.cloud.ru/.../viewport_step_1"   â”‚  â”‚
â”‚ â”‚    type: "viewport"                                       â”‚  â”‚
â”‚ â”‚    width: 2048, height: 1024                             â”‚  â”‚
â”‚ â”‚                                                           â”‚  â”‚
â”‚ â”‚  - image_id: "def456"                                     â”‚  â”‚
â”‚ â”‚    name: "zoom_crop_1.png"                                â”‚  â”‚
â”‚ â”‚    s3_path: "chats/.../images/zoom_crop_1.png"          â”‚  â”‚
â”‚ â”‚    s3_url: "https://s3.cloud.ru/.../zoom_crop_1"       â”‚  â”‚
â”‚ â”‚    type: "zoom_crop"                                      â”‚  â”‚
â”‚ â”‚    width: 512, height: 512                               â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Message 3                                                 â”‚  â”‚
â”‚ â”‚ Role: user                                                â”‚  â”‚
â”‚ â”‚ Content: "Ğ”Ğ°Ğ¹ Ğ±Ğ¾Ğ»ĞµĞµ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·"                   â”‚  â”‚
â”‚ â”‚ Created: 10:31:00                                         â”‚  â”‚
â”‚ â”‚ Images: []                                                â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚ ... MORE MESSAGES ...                                          â”‚
â”‚                                                                 â”‚
â”‚ SEARCH RESULTS:                                                â”‚
â”‚  - Block 1: "Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ğ¸Ğ¸ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¸Ğ·..."              â”‚
â”‚    Page: 5, Coords: [0.1, 0.2, 0.8, 0.5]                    â”‚
â”‚  - Block 2: "Ğ¢Ğ¸Ğ¿Ñ‹ Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ²: Ñ†ĞµĞ½Ñ‚Ñ€Ğ¾Ğ±ĞµĞ¶Ğ½Ñ‹Ğµ, Ğ¾ÑĞµĞ²Ñ‹Ğµ..."   â”‚
â”‚    Page: 6, Coords: [0.2, 0.3, 0.9, 0.6]                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸)

```
aizoomdoc/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                    âœï¸ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ
â”‚   â”œâ”€â”€ supabase_client.py           âœ¨ ĞĞĞ’Ğ«Ğ™
â”‚   â”œâ”€â”€ s3_storage.py                âœ¨ ĞĞĞ’Ğ«Ğ™
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ gui.py
â”‚   â”œâ”€â”€ llm_client.py
â”‚   â”œâ”€â”€ search_engine.py
â”‚   â”œâ”€â”€ image_processor.py
â”‚   â”œâ”€â”€ annotation_loader.py
â”‚   â”œâ”€â”€ markdown_parser.py
â”‚   â””â”€â”€ models.py
â”‚
â”œâ”€â”€ migrations/                      âœ¨ ĞĞĞ’ĞĞ¯ ĞŸĞĞŸĞšĞ
â”‚   â”œâ”€â”€ alembic.ini                 âœ¨ ĞĞĞ’Ğ«Ğ™
â”‚   â”œâ”€â”€ env.py                      âœ¨ ĞĞĞ’Ğ«Ğ™
â”‚   â”œâ”€â”€ script.py.mako              (ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚ Alembic)
â”‚   â””â”€â”€ versions/
â”‚       â””â”€â”€ 001_initial_schema.py   âœ¨ ĞĞĞ’Ğ«Ğ™
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ manage_db.py                âœ¨ ĞĞĞ’Ğ«Ğ™
â”‚   â”œâ”€â”€ run_example.bat
â”‚   â”œâ”€â”€ run_example.sh
â”‚   â”œâ”€â”€ setup.bat
â”‚   â””â”€â”€ setup.sh
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ chats/                      (Ğ½Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ»Ğ°ĞºĞ°)
â”‚   â”œâ”€â”€ viewports/
â”‚   â”œâ”€â”€ stage_p/
â”‚   â”œâ”€â”€ stage_r/
â”‚   â””â”€â”€ llm_system_prompt.txt
â”‚
â”œâ”€â”€ requirements.txt                âœï¸ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ
â”œâ”€â”€ env.example                     âœï¸ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ
â”œâ”€â”€ .env                            (Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑĞ´Ğ° ĞºĞ»ÑÑ‡Ğ¸)
â”œâ”€â”€ config.py
â”œâ”€â”€ setup.py
â”‚
â”œâ”€â”€ DATABASE_ARCHITECTURE.md         âœ¨ ĞĞĞ’Ğ«Ğ™
â”œâ”€â”€ SUPABASE_S3_INTEGRATION.md       âœ¨ ĞĞĞ’Ğ«Ğ™
â”œâ”€â”€ IMPLEMENTATION_PLAN.md           âœ¨ ĞĞĞ’Ğ«Ğ™
â”œâ”€â”€ SUPABASE_S3_SETUP_SUMMARY.md    âœ¨ ĞĞĞ’Ğ«Ğ™
â”œâ”€â”€ CHECKLIST.md                     âœ¨ ĞĞĞ’Ğ«Ğ™
â”œâ”€â”€ INTEGRATION_EXAMPLES.py          âœ¨ ĞĞĞ’Ğ«Ğ™
â”œâ”€â”€ ARCHITECTURE.md
â”œâ”€â”€ README.md
â”œâ”€â”€ QUICKSTART.md
â””â”€â”€ ... Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
```

---

## Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸

### 1. Ğ’ gui.py Ğ¸Ğ»Ğ¸ gui_agent.py

```python
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
from src.supabase_client import supabase_client
from src.s3_storage import s3_storage

# ĞŸÑ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
async def on_new_analysis(file_path, query):
    # 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‡Ğ°Ñ‚ Ğ² Ğ‘Ğ”
    chat_id = await supabase_client.create_chat(
        title=f"ĞĞ½Ğ°Ğ»Ğ¸Ğ· {Path(file_path).name}",
        user_id=current_user_id
    )
    
    # 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    msg_id = await supabase_client.add_message(
        chat_id=chat_id,
        role="user",
        content=query
    )
    
    # 3. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
    ...
```

### 2. Ğ’ image_processor.py

```python
# ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
async def process_viewport(image_path, chat_id):
    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ² S3
    s3_url = await s3_storage.upload_file(
        file_path=image_path,
        s3_key=f"chats/{chat_id}/images/viewport.png"
    )
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ğ‘Ğ”
    await supabase_client.add_image_to_message(
        chat_id=chat_id,
        message_id=msg_id,
        image_name="viewport.png",
        s3_path=f"chats/{chat_id}/images/viewport.png",
        s3_url=s3_url
    )
```

### 3. Ğ’ llm_client.py

```python
# ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ LLM
async def process_response(response, chat_id):
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ² Ğ‘Ğ”
    msg_id = await supabase_client.add_message(
        chat_id=chat_id,
        role="assistant",
        content=response
    )
    
    # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸ - Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ
    for image in response_images:
        await s3_storage.upload_file(...)
        await supabase_client.add_image_to_message(...)
```

---

## ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```
Logger: supabase_client
â”œâ”€â”€ âœ… Supabase ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
â”œâ”€â”€ âœ… Ğ§Ğ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½: {chat_id}
â”œâ”€â”€ âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {msg_id}
â”œâ”€â”€ âœ… ĞšĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°: {img_id}
â”œâ”€â”€ âœ… Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½: {result_id}
â”œâ”€â”€ âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°: {error}
â””â”€â”€ âš ï¸  Supabase Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½

Logger: s3_storage
â”œâ”€â”€ âœ… S3 ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
â”œâ”€â”€ âœ… Ğ‘Ğ°ĞºĞµÑ‚ 'cloud-aizoomdoc' Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
â”œâ”€â”€ âœ… Ğ¤Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½: {s3_key}
â”œâ”€â”€ âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¹ URL Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½: {s3_key}
â”œâ”€â”€ âœ… Ğ¤Ğ°Ğ¹Ğ» ÑƒĞ´Ğ°Ğ»ĞµĞ½: {s3_key}
â”œâ”€â”€ âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° {s3_key}: {error}
â””â”€â”€ âš ï¸  S3 Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½
```

---

## Graceful Fallback (ĞµÑĞ»Ğ¸ Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ         â”‚
      â”‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ       â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OK    â”‚                            â”‚ FAILED
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
               â”‚                  â”‚ Log warning â”‚
               â”‚                  â”‚ Use local   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ storage     â”‚
        â”‚ Use cloud DB    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ and S3 storage  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ğ’ÑĞµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹:
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑÑ‚ .is_connected()
- Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ warning ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹
- Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ÑÑ‚ None/False Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
- ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ÑÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸
```

---

## Ğ Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ° production

```
Production:
â”œâ”€â”€ Application (AWS EC2 / Digital Ocean / VPS)
â”‚   â”œâ”€â”€ src/ (ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
â”‚   â”œâ”€â”€ .env (Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ)
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ Supabase PostgreSQL (Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾)
â”‚   â”œâ”€â”€ chats table
â”‚   â”œâ”€â”€ chat_messages table
â”‚   â”œâ”€â”€ chat_images table
â”‚   â””â”€â”€ search_results table
â”‚
â”œâ”€â”€ S3 Cloud.ru (Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾)
â”‚   â””â”€â”€ cloud-aizoomdoc bucket
â”‚       â””â”€â”€ chats/{chat_id}/
â”‚           â”œâ”€â”€ documents/
â”‚           â””â”€â”€ images/
â”‚
â””â”€â”€ Backup Service
    â”œâ”€â”€ Supabase Auto Backup
    â””â”€â”€ S3 Lifecycle Policies
```

---

## Performance Optimization

```
Database Queries:
â”œâ”€â”€ Indexed fields for fast lookup
â”‚   â”œâ”€â”€ chats.user_id
â”‚   â”œâ”€â”€ chats.created_at
â”‚   â”œâ”€â”€ chat_messages.chat_id
â”‚   â”œâ”€â”€ chat_images.chat_id
â”‚   â””â”€â”€ search_results.chat_id
â”‚
â””â”€â”€ Pagination for large datasets
    â”œâ”€â”€ get_chats(limit=20, offset=0)
    â”œâ”€â”€ get_chat_messages(chat_id)
    â””â”€â”€ list_files(prefix) in S3

Caching (optional):
â”œâ”€â”€ Redis for chat list
â”œâ”€â”€ Local file cache for images
â””â”€â”€ CloudFlare CDN for S3 URLs

Connection Pooling:
â”œâ”€â”€ Supabase: 10-20 connections
â””â”€â”€ S3: Connection reuse via boto3
```

---

**Architecture Version:** 1.0
**Last Updated:** 2025-12-18
**Status:** âœ… Complete
