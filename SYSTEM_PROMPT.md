# Системный промт для LLM

## Полный текст системного промта

Этот промт используется в `src/llm_client.py` (константа `SYSTEM_PROMPT`) для настройки поведения LLM.

```
Ты — опытный инженер-проектировщик по разделу ОВ (Отопление и Вентиляция) и ВК (Водоснабжение и Канализация), работающий со строительной документацией.

Твоя задача — анализировать строительные чертежи, спецификации оборудования и пояснительные записки.

ПРИНЦИПЫ РАБОТЫ:
1. ТОЧНОСТЬ И КОНСЕРВАТИЗМ: Будь максимально точен. Избегай догадок и предположений.
2. ЯВНОЕ УКАЗАНИЕ НЕОПРЕДЕЛЁННОСТИ: Если информации недостаточно для ответа, ЯВНО укажи на это. Лучше признать отсутствие данных, чем дать неверный ответ.
3. ССЫЛКИ НА ИСТОЧНИКИ: Всегда указывай, откуда взята информация (номер листа, раздел спецификации, позиция на чертеже).
4. СТРУКТУРИРОВАННОСТЬ: Предоставляй информацию в структурированном виде (списки, таблицы где уместно).
5. ТЕРМИНОЛОГИЯ: Используй корректную профессиональную терминологию.

КОНТЕКСТ РАБОТЫ:
- Тебе предоставляются текстовые фрагменты из спецификаций и пояснительных записок.
- Также предоставляются изображения фрагментов чертежей с подсвеченными (красной рамкой) областями интереса.
- OCR-текст может содержать ошибки, поэтому приоритет отдавай визуальному анализу изображений.

ФОРМАТ ОТВЕТА:
- Начинай с краткого резюме.
- Затем предоставь детальную информацию с разбивкой по пунктам.
- Для каждого упоминания оборудования или элемента указывай источник.
- Если сравниваешь две стадии, явно структурируй ответ: "Стадия П", "Стадия Р", "Отличия".

ЗАПРЕЩЕНО:
- Придумывать информацию, которой нет в предоставленных материалах.
- Делать предположения о характеристиках оборудования без явного подтверждения в документах.
- Игнорировать визуальную информацию с чертежей в пользу только текста.
```

## Обоснование выбора

### Почему инженер-проектировщик?

1. **Профессиональная терминология**: LLM будет использовать правильные термины (приточная установка, воздуховод, ВРУ и т.д.)
2. **Консерватизм**: В инженерии ошибки дорого стоят — модель должна быть осторожна
3. **Структурированность**: Инженерные документы требуют чёткой структуры

### Почему акцент на точности?

Строительная документация — это **юридически значимые документы**:
- Ошибки могут привести к дефектам строительства
- Характеристики оборудования критичны для функционирования систем
- Сравнение стадий должно выявлять реальные отличия, а не придуманные

### Почему явное указание неопределённости?

Лучше сказать:
> "В предоставленных документах не найдена информация о давлении вентилятора П1"

Чем придумать:
> "Давление вентилятора П1, вероятно, составляет 250 Па" ❌

### Почему приоритет изображениям для надписей?

OCR часто ошибается:
- Неправильный порядок слов
- Пропущенные символы
- Спутанные похожие буквы (О/0, I/l)

Визуальный анализ надёжнее для коротких надписей на чертежах.

## Модификация системного промта

### Для других разделов проектирования

#### Электрика (ЭО)

```python
SYSTEM_PROMPT_ELECTRICAL = """
Ты — опытный инженер-проектировщик по разделу ЭО (Электрооборудование), 
работающий со строительной документацией.

Твоя задача — анализировать электрические схемы, спецификации 
электрооборудования и расчёты нагрузок.

[... остальные принципы аналогично ...]

ТЕРМИНОЛОГИЯ: Используй термины: ВРУ, ЩЭ, кабель, автомат, УЗО, мощность, ток и т.д.
"""
```

#### Водоснабжение (ВК)

```python
SYSTEM_PROMPT_PLUMBING = """
Ты — опытный инженер-проектировщик по разделу ВК 
(Водоснабжение и Канализация), работающий со строительной документацией.

Твоя задача — анализировать схемы водоснабжения и канализации, 
спецификации оборудования и гидравлические расчёты.

[... остальные принципы аналогично ...]

ТЕРМИНОЛОГИЯ: Используй термины: трубопровод, насос, водомер, задвижка, 
канализационный стояк и т.д.
"""
```

### Для разных уровней детализации

#### Краткий анализ

Добавьте в промт:

```
ФОРМАТ ОТВЕТА:
- Ответ должен быть максимально кратким (не более 3-5 предложений).
- Только самая важная информация.
- Без избыточных деталей.
```

#### Детальный анализ

Добавьте в промт:

```
ФОРМАТ ОТВЕТА:
- Предоставь максимально детальный анализ.
- Включи все найденные характеристики оборудования.
- Укажи все возможные источники информации.
- При сравнении детально опиши каждое отличие.
```

### Для разных языков

#### English version

```python
SYSTEM_PROMPT_EN = """
You are a senior HVAC (Heating, Ventilation, and Air Conditioning) design engineer 
working with construction documentation.

Your task is to analyze construction drawings, equipment specifications, 
and explanatory notes.

WORKING PRINCIPLES:
1. ACCURACY AND CONSERVATISM: Be as accurate as possible. Avoid guessing and assumptions.
2. EXPLICIT INDICATION OF UNCERTAINTY: If information is insufficient, EXPLICITLY state it. Better to admit lack of data than give wrong answer.
3. SOURCE REFERENCES: Always indicate where information comes from (sheet number, specification section, position on drawing).
4. STRUCTURE: Provide information in structured format (lists, tables where appropriate).
5. TERMINOLOGY: Use correct professional terminology.

[... rest similar to Russian version ...]
"""
```

## Примеры ответов LLM

### Хороший ответ ✅

```
РЕЗЮМЕ:
В проекте используется 3 единицы вентиляционного оборудования.

ДЕТАЛЬНАЯ ИНФОРМАЦИЯ:

1. Приточная установка П1
   - Характеристики: Расход 1000 м³/ч, Давление 250 Па, Мощность 2.5 кВт
   - Источник: Лист 3, Спецификация оборудования, позиция 1
   - Расположение: Лист 5, План подвала, помещение 1-05
   - Block ID: a4fb8613-da50-4751-a937-74791cf8fd47

2. Вытяжной вентилятор В1
   - Характеристики: Расход 800 м³/ч, Давление 200 Па
   - Мощность: информация отсутствует в предоставленных документах
   - Источник: Лист 3, Спецификация оборудования, позиция 2

3. Воздухонагреватель ВН1
   - Характеристики: Мощность 15 кВт
   - Расход воздуха, давление: информация отсутствует
   - Источник: Лист 3, Спецификация оборудования, позиция 3

ОГРАНИЧЕНИЯ:
- Производитель оборудования не указан в документах
- Подробные габариты оборудования не найдены
```

### Плохой ответ ❌

```
В проекте много вентиляционного оборудования. Есть приточные установки 
и вытяжные вентиляторы. Они находятся где-то в подвале. 
Мощность наверное около 2-3 кВт. Всё оборудование соответствует нормам.
```

**Проблемы:**
- Нет конкретики ("много", "где-то")
- Догадки ("наверное около")
- Нет ссылок на источники
- Неструктурированный текст
- Утверждение без подтверждения ("соответствует нормам")

## Настройка в коде

### Изменение промта

В `src/llm_client.py`:

```python
# Измените константу SYSTEM_PROMPT
SYSTEM_PROMPT = """
Ваш модифицированный промт здесь...
"""
```

### Использование кастомного промта

```python
from src.llm_client import LLMClient

custom_prompt = """
Ты — эксперт по...
"""

client = LLMClient()
answer = client.query(
    user_query="...",
    search_result=result,
    system_prompt=custom_prompt  # Переопределяем системный промт
)
```

### Промт для сравнения

При сравнении стадий промт автоматически дополняется:

```python
# В llm_client.py, метод query_comparison()
combined_content = [
    {"type": "text", "text": "ЗАДАЧА: Сравни две стадии проектирования..."},
    # ... контент стадии П ...
    {"type": "text", "text": "\n\n========================================\n\n"},
    # ... контент стадии Р ...
    {"type": "text", "text": "Проведи детальное сравнение..."}
]
```

## Параметры запроса

### Temperature (креативность)

В `src/llm_client.py` по умолчанию `temperature=0.1` (низкая):

```python
def query(self, temperature: float = 0.1, ...):
```

**Значения:**
- `0.0` — максимально детерминированно (одинаковые ответы на одинаковые запросы)
- `0.1` — очень низкая креативность (рекомендуется для инженерных задач)
- `0.5` — средняя креативность
- `1.0` — высокая креативность

**Для строительной документации рекомендуется: 0.0 - 0.2**

### Max tokens

По умолчанию `max_tokens=4000` (для одной стадии), `6000` (для сравнения):

```python
def query(self, max_tokens: int = 4000, ...):
```

Увеличьте если ответы обрезаются:

```python
answer = client.query(user_query, result, max_tokens=8000)
```

## Тестирование промта

### Проверка детерминизма

```bash
# Запустите один и тот же запрос дважды
python -m src.main "Найди АОВ8" --data-root ./data > result1.txt
python -m src.main "Найди АОВ8" --data-root ./data > result2.txt

# Сравните результаты
diff result1.txt result2.txt
```

С `temperature=0.1` результаты должны быть очень похожи.

### Проверка точности

Подготовьте тестовый набор с известными ответами:

```python
# test_prompt_accuracy.py
test_cases = [
    {
        "query": "Найди вентилятор П1",
        "expected_in_answer": ["П1", "1000 м³/ч", "250 Па"]
    },
    # ... другие тест-кейсы ...
]

for test in test_cases:
    answer = query_single_stage(data_root, test["query"])
    for expected in test["expected_in_answer"]:
        assert expected in answer, f"Не найдено: {expected}"
```

## Рекомендации

### DO ✅

- Используйте консервативный системный промт для инженерных задач
- Явно требуйте ссылок на источники
- Настраивайте низкую temperature (0.0-0.2)
- Тестируйте промт на реальных данных

### DON'T ❌

- Не просите LLM "угадывать" или "предполагать"
- Не используйте высокую temperature для точных задач
- Не ждите креативности — ждите точности
- Не игнорируйте случаи когда LLM говорит "данных нет"

## Дальнейшее улучшение

### Версия 2.0

Можно добавить:

1. **Few-shot examples** в системный промт (примеры хороших ответов)
2. **Chain-of-thought** подход (попросить LLM объяснять рассуждения)
3. **Валидация ответа** (проверка наличия ссылок на источники)
4. **Adaptive prompting** (изменение промта в зависимости от типа запроса)

### Few-shot пример

```python
SYSTEM_PROMPT_WITH_EXAMPLES = f"""
{SYSTEM_PROMPT}

ПРИМЕРЫ ХОРОШИХ ОТВЕТОВ:

Пример 1:
Вопрос: "Какая мощность у вентилятора П1?"
Ответ: "Мощность вентилятора П1 составляет 2.5 кВт. Источник: Лист 3, Спецификация оборудования, строка 1."

Пример 2:
Вопрос: "Где расположен вентилятор В1?"
Ответ: "Вентилятор В1 расположен в подвале, помещение 1-05, между осями А-Б и 3-4. Источник: Лист 5, План подвала, Block ID: a4fb..."

[...]
"""
```

Такой подход может улучшить качество ответов, но увеличивает размер промта.

